"""
アプリケーションの設定を管理するモジュール
"""

import streamlit as st
import os
import json
from dotenv import load_dotenv
from datetime import datetime

# 環境変数の読み込み
load_dotenv()

# API Keys
PINECONE_API_KEY = os.getenv("PINECONE_API_KEY") or st.secrets.get("pinecone_key")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY") or st.secrets.get("openai_api_key")

# Pinecone Settings
PINECONE_INDEX_NAME = os.getenv("PINECONE_INDEX_NAME") or st.secrets.get("index_name")
PINECONE_ASSISTANT_NAME = os.getenv("PINECONE_ASSISTANT_NAME") or st.secrets.get("assistant_name")

# Text Processing Settings
CHUNK_SIZE = 500  # テキストを分割する際の1チャンクあたりの文字数
BATCH_SIZE = 100  # Pineconeへのアップロード時のバッチサイズ

# OpenAI Settings
EMBEDDING_MODEL = "text-embedding-3-large"  # 使用する埋め込みモデル
EMBEDDING_DIMENSION = 3072  # 埋め込みベクトルの次元数

# Search Settings
DEFAULT_TOP_K = 10  # デフォルトの検索結果数
SIMILARITY_THRESHOLD = 0.4  # 類似度のしきい値（0-1の範囲）

# Metadata Settings
DEFAULT_CREATION_DATE = datetime.now().strftime("%Y-%m-%d %H:%M:%S")  # メタデータの作成日が空の場合のデフォルト値

def get_metadata_creation_date(metadata):
    """
    メタデータの作成日を取得する関数
    作成日が空の場合は現在の日時を返す
    """
    if not metadata or "creation_date" not in metadata or not metadata["creation_date"]:
        return DEFAULT_CREATION_DATE
    return metadata["creation_date"]

# Prompt Settings
# プロンプトテンプレートの保存と読み込み
PROMPT_TEMPLATES_FILE = "prompt_templates.json"

def save_prompt_templates(templates):
    """プロンプトテンプレートを保存"""
    with open(PROMPT_TEMPLATES_FILE, "w", encoding="utf-8") as f:
        json.dump(templates, f, ensure_ascii=False, indent=2)

def load_prompt_templates():
    """プロンプトテンプレートを読み込み"""
    if os.path.exists(PROMPT_TEMPLATES_FILE):
        with open(PROMPT_TEMPLATES_FILE, "r", encoding="utf-8") as f:
            templates = json.load(f)
            # デフォルトテンプレートを取得
            default_template = next((t for t in templates if t["name"] == "デフォルト"), None)
            if default_template:
                return templates, default_template["system_prompt"], default_template["response_template"]
    return [], "", ""

# プロンプトテンプレートの読み込み
PROMPT_TEMPLATES, DEFAULT_SYSTEM_PROMPT, DEFAULT_RESPONSE_TEMPLATE = load_prompt_templates()

# メタデータ設定
METADATA_CATEGORIES = {
    "大カテゴリ": [
        "物件概要",
        "地域特性・街のプロフィール",
        "教育・子育て",
        "交通・アクセス",
        "安全・防災",
        "行政施策・政策",
        "生活利便性",
        "不動産市場",
        "地域コミュニティ",
        "その他（個別の懸念・特殊事情）"
    ],
    "中カテゴリ": {
        "物件概要": [
            "完成時期",
            "販売開始",
            "建築確認",
            "間取り・仕様",
            "設備・オプション",
            "デザイン・外観",
            "建築会社・デベロッパー",
            "価格・費用",
            "資産価値・売却",
            "契約・手続き"
        ],
        "地域特性・街のプロフィール": [
            "概要・エリア区分",
            "人口・居住特性",
            "街の歴史・地域史",
            "地理的特性",
            "自然環境",
            "地域イベント・伝統行事",
            "都市連携・姉妹都市情報",
            "治安・騒音・環境整備",
            "風景・景観・街並み",
            "観光・地元特産品・名産・グルメ"
        ],
        "教育・子育て": [
            "保育園・幼稚園",
            "小学校・中学校",
            "学童・放課後支援",
            "習い事・塾",
            "子育て支援制度",
            "公園・遊び場",
            "病院・小児科",
            "学区・教育水準",
            "待機児童・入園状況",
            "学校イベント・行事"
        ],
        "交通・アクセス": [
            "最寄り駅・路線",
            "電車の混雑状況",
            "バス路線・本数",
            "駐輪場・駐車場",
            "道路交通量・渋滞",
            "車移動のしやすさ",
            "通勤・通学時間",
            "高速道路・インター",
            "タクシー・ライドシェア",
            "空港・新幹線アクセス"
        ],
        "安全・防災": [
            "防犯カメラ・交番の有無",
            "避難場所・防災拠点",
            "ハザードマップ（洪水・地震）",
            "土砂災害リスク",
            "耐震性・建物強度",
            "火災リスク・消防体制",
            "夜道の安全性",
            "台風・風害・雪害対策",
            "地震・液状化リスク",
            "交通事故・子ども見守り"
        ],
        "行政施策・政策": [
            "市政・行政組織",
            "再開発・都市計画",
            "交通インフラ整備",
            "公共施設運営・市民サービス",
            "ゴミ収集・清掃環境",
            "商業・産業振興策",
            "住宅政策・住環境整備",
            "福祉・医療支援",
            "補助金・助成制度",
            "行政評価・市民参加"
        ],
        "生活利便性": [
            "スーパー・買い物環境",
            "コンビニ・ドラッグストア",
            "銀行・金融機関・郵便局",
            "公共施設",
            "病院・クリニック・夜間救急",
            "文化施設・美術館・劇場",
            "スポーツ施設・ジム",
            "娯楽施設・カラオケ・映画館",
            "飲食店・グルメスポット",
            "宅配サービス・ネットスーパー"
        ],
        "不動産市場": [
            "地価の変動・推移",
            "将来の売却しやすさ",
            "賃貸需要・投資価値",
            "住宅ローン・金利動向",
            "人気エリアの傾向",
            "空き家・中古市場動向",
            "固定資産税・税制優遇",
            "マンション vs 戸建て",
            "住み替え・転勤時の影響",
            "不動産会社の評判・実績"
        ],
        "地域コミュニティ": [
            "自治会・町内会の活動",
            "地域の祭り",
            "ボランティア活動",
            "住民の意識・口コミ",
            "高齢者支援・福祉施設",
            "外国人コミュニティ",
            "風評・悪評の実態",
            "市民幸福度・満足度",
            "地域振興・コミュニティ活性化"
        ],
        "その他（個別の懸念・特殊事情）": [
            "スマートシティ・DX施策",
            "エコ対策・再生可能エネルギー",
            "観光客・短期滞在者の影響",
            "景観条例・建築規制",
            "駐車場問題・車両ルール",
            "宅配便・物流インフラ"
        ]
    },
    "市区町村": [
        "川越市",
        "さいたま市",
        "千葉市",
        "横浜市",
        "川崎市",
        "相模原市",
    ],
    "質問文例": {
        "物件概要": [
            "この物件の完成時期はいつですか？",
            "販売開始時期を教えてください",
            "建築確認は取れていますか？",
            "間取りと仕様について詳しく教えてください",
            "設備やオプションは何がありますか？",
            "デザインや外観の特徴は？",
            "建築会社やデベロッパーはどこですか？",
            "価格や費用の内訳を教えてください",
            "資産価値や売却時のことを教えてください",
            "契約や手続きについて教えてください"
        ],
        "地域特性・街のプロフィール": [
            "このエリアの概要を教えてください",
            "人口や居住特性について教えてください",
            "街の歴史や地域史について教えてください",
            "地理的特性について教えてください",
            "自然環境について教えてください",
            "地域イベントや伝統行事はありますか？",
            "都市連携や姉妹都市情報を教えてください",
            "治安や騒音、環境整備について教えてください",
            "風景や景観、街並みについて教えてください",
            "観光や地元特産品、グルメについて教えてください"
        ],
        "教育・子育て": [
            "近くの保育園や幼稚園について教えてください",
            "小学校や中学校について教えてください",
            "学童や放課後支援について教えてください",
            "習い事や塾について教えてください",
            "子育て支援制度について教えてください",
            "公園や遊び場について教えてください",
            "病院や小児科について教えてください",
            "学区や教育水準について教えてください",
            "待機児童や入園状況について教えてください",
            "学校イベントや行事について教えてください"
        ],
        "交通・アクセス": [
            "最寄り駅や路線について教えてください",
            "電車の混雑状況について教えてください",
            "バス路線や本数について教えてください",
            "駐輪場や駐車場について教えてください",
            "道路交通量や渋滞について教えてください",
            "車移動のしやすさについて教えてください",
            "通勤や通学時間について教えてください",
            "高速道路やインターについて教えてください",
            "タクシーやライドシェアについて教えてください",
            "空港や新幹線アクセスについて教えてください"
        ],
        "安全・防災": [
            "防犯カメラや交番の有無について教えてください",
            "避難場所や防災拠点について教えてください",
            "ハザードマップ（洪水・地震）について教えてください",
            "土砂災害リスクについて教えてください",
            "耐震性や建物強度について教えてください",
            "火災リスクや消防体制について教えてください",
            "夜道の安全性について教えてください",
            "台風や風害、雪害対策について教えてください",
            "地震や液状化リスクについて教えてください",
            "交通事故や子ども見守りについて教えてください"
        ],
        "行政施策・政策": [
            "市政や行政組織について教えてください",
            "再開発や都市計画について教えてください",
            "交通インフラ整備について教えてください",
            "公共施設運営や市民サービスについて教えてください",
            "ゴミ収集や清掃環境について教えてください",
            "商業や産業振興策について教えてください",
            "住宅政策や住環境整備について教えてください",
            "福祉や医療支援について教えてください",
            "補助金や助成制度について教えてください",
            "行政評価や市民参加について教えてください"
        ],
        "生活利便性": [
            "スーパーや買い物環境について教えてください",
            "コンビニやドラッグストアについて教えてください",
            "銀行や金融機関、郵便局について教えてください",
            "公共施設について教えてください",
            "病院やクリニック、夜間救急について教えてください",
            "文化施設や美術館、劇場について教えてください",
            "スポーツ施設やジムについて教えてください",
            "娯楽施設やカラオケ、映画館について教えてください",
            "飲食店やグルメスポットについて教えてください",
            "宅配サービスやネットスーパーについて教えてください"
        ],
        "不動産市場": [
            "地価の変動や推移について教えてください",
            "将来の売却しやすさについて教えてください",
            "賃貸需要や投資価値について教えてください",
            "住宅ローンや金利動向について教えてください",
            "人気エリアの傾向について教えてください",
            "空き家や中古市場動向について教えてください",
            "固定資産税や税制優遇について教えてください",
            "マンションと戸建ての比較について教えてください",
            "住み替えや転勤時の影響について教えてください",
            "不動産会社の評判や実績について教えてください"
        ],
        "地域コミュニティ": [
            "自治会や町内会の活動について教えてください",
            "地域の祭りについて教えてください",
            "ボランティア活動について教えてください",
            "住民の意識や口コミについて教えてください",
            "高齢者支援や福祉施設について教えてください",
            "外国人コミュニティについて教えてください",
            "風評や悪評の実態について教えてください",
            "市民幸福度や満足度について教えてください",
            "地域振興やコミュニティ活性化について教えてください"
        ],
        "その他（個別の懸念・特殊事情）": [
            "スマートシティやDX施策について教えてください",
            "エコ対策や再生可能エネルギーについて教えてください",
            "観光客や短期滞在者の影響について教えてください",
            "景観条例や建築規制について教えてください",
            "駐車場問題や車両ルールについて教えてください",
            "宅配便や物流インフラについて教えてください"
        ]
    }
} 